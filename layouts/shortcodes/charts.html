<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.0.4/build/global/luxon.min.js"></script>

<div class="chart-container">
  <h2>ä½“é‡</h2>
  <div class="chart" id="weight"></div>
</div>
<div class="chart-container">
  <h2>å¥¶é‡</h2>
  <div class="chart" id="feeding"></div>
  <div class="chart" id="feeding-by-hour"></div>
</div>
<div class="chart-container">
  <h2>é»„ç–¸</h2>
  <div class="chart" id="br"></div>
</div>

<script type="text/javascript">
  const getDaysArray = function (start, end) {
    for (var arr = [], dt = new Date(start); dt <= new Date(end); dt.setDate(dt.getDate() + 1)) {
      arr.push((new Date(dt)).toLocaleDateString("sv"));
    }
    return arr;
  };
  const DateTime = luxon.DateTime;
  class Weight {
    constructor(record_at, value) {
      this.record_at = record_at;
      this.value = value;
    }
  }
  const locales = [{
    "name": "zh-cn",
    "options": {
      "months": ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"],
      "shortMonths": ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"],
      "days": ["æ˜ŸæœŸå¤©", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­"],
      "shortDays": ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"],
      "toolbar": { "exportToSVG": "ä¸‹è½½ SVG", "exportToPNG": "ä¸‹è½½ PNG", "exportToCSV": "ä¸‹è½½ CSV", "menu": "èœå•", "selection": "é€‰æ‹©", "selectionZoom": "é€‰æ‹©ç¼©æ”¾", "zoomIn": "æ”¾å¤§", "zoomOut": "ç¼©å°", "pan": "å¹³ç§»", "reset": "é‡ç½®ç¼©æ”¾" }
    }
  }]
  const base = supabase.createClient(
    'https://tpfryrnbzljbbbkqzoxz.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwZnJ5cm5iemxqYmJia3F6b3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2NjM0ODI4MDksImV4cCI6MTk3OTA1ODgwOX0.JjjxFyTh_OhKTs-cd_Er3vwI9Mpd8ACAstrt3sIGENs'
  )
  base.from("arthur-br").select().order('record_at', { ascending: true })
    .then((response) => response.data)
    .then((data) => {
      var brOptions = {
        chart: {
          locales: locales,
          defaultLocale: "zh-cn",
          type: 'line'
        },
        series: [
          {
            name: "é¢éƒ¨",
            data: data.map((metric) => metric.value_face),
          },
          {
            name: "èº«ä½“",
            data: data.map((metric) => metric.value_body),
          },
        ],
        stroke: {
          width: 3,
          curve: 'smooth'
        },
        xaxis: {
          type: "datetime",
          categories: data.map((metric) => metric.record_at),
          labels: {
            datetimeUTC: false,
          }
        },
        annotations: {
          yaxis: [
            {
              y: 18,
              borderColor: "#CC3636",
              label: {
                borderColor: "#F57328",
                style: {
                  color: "#fff",
                  background: "#F57328",
                },
                text: "ä¸Šé™ğŸ˜±",
              },
            },
            {
              y: 7.5,
              borderColor: "#2FDB5D",
              label: {
                borderColor: "#2FDB5D",
                position: 'left',
                offsetX: 40,
                style: {
                  color: "#fff",
                  background: "#7ED930",
                },
                text: "å¥åº· 7.5",
              },
            },
          ],
          points: data.filter(v => v.notes != null && v.notes != "").map(p => {
            return {
              x: new Date(p.record_at).getTime(),
              y: p.value_body,
              marker: {
                size: 2,
              },
              label: {
                borderColor: "#5BBCF0",
                text: p.notes,
              },
            }
          }),
          xaxis: [
            {
              x: new Date("2022-09-02T08:00:00").getTime(),
              x2: new Date("2022-09-02T16:00:00").getTime(),
              borderColor: "#775DD0",
              fillColor: "blue",
              label: {
                text: "ç…§è“å…‰1",
              },
            },
            {
              x: new Date("2022-09-03T08:00:00").getTime(),
              x2: new Date("2022-09-03T16:00:00").getTime(),
              borderColor: "#775DD0",
              fillColor: "blue",
              label: {
                text: "ç…§è“å…‰2",
              },
            },
            {
              x: new Date("2022-09-04T08:00:00").getTime(),
              x2: new Date("2022-09-04T16:00:00").getTime(),
              borderColor: "#775DD0",
              fillColor: "blue",
              label: {
                text: "ç…§è“å…‰3",
              },
            },
          ],
        },
      }
      let chart = new ApexCharts(document.querySelector("#br"), brOptions);
      chart.render();
    })
  base.from("arthur-weight").select().order('record_at', { ascending: true })
    .then((response) => response.data)
    .then((data) => {
      let options = {
        chart: {
          locales: locales,
          defaultLocale: "zh-cn",
          type: 'line'
        },
        stroke: {
          width: 4
        },
        series: [
          {
            name: "ä½“é‡",
            data: data.map((metric) => metric.value),
          }
        ],
        forecastDataPoints: {
          count: 3
        },
        stroke: {
          width: 5,
          curve: 'smooth'
        },
        xaxis: {
          type: "datetime",
          categories: data.map((metric) => metric.record_at),
          labels: {
            datetimeUTC: false,
          }
        },
        fill: {
          type: 'gradient',
          gradient: {
            shade: 'dark',
            gradientToColors: ['#FDD835'],
            shadeIntensity: 1,
            type: 'horizontal',
            opacityFrom: 1,
            opacityTo: 1,
            stops: [0, 100, 100, 100]
          },
        },
        annotations: {
          points: data.filter(v => v.notes != null && v.notes != "").map(p => {
            return {
              x: new Date(p.record_at).getTime(),
              y: p.value,
              marker: {
                size: 2,
              },
              label: {
                borderColor: "#5BBCF0",
                text: p.notes,
              },
            }
          }),
          yaxis: [
            {
              y: 3790,
              borderColor: "#CC3636",
              label: {
                borderColor: "#F57328",
                position: 'left',
                offsetX: 40,
                style: {
                  color: "#fff",
                  background: "#F57328",
                },
                text: "å¢é‡1ã",
              },
            },
          ],
        }
      }
      let chart = new ApexCharts(document.querySelector("#weight"), options);
      chart.render();
    })
  base.from("arthur-feeding").select().order('record_at', { ascending: true })
    .then((response) => response.data)
    .then((data) => {
      data_by_date = data.reduce((groups, feed) => {
        const date = (new Date(feed.record_at)).toLocaleDateString("sv");
        if (!groups[date]) {
          groups[date] = {
            total: 0,
            max: 0
          };
        }
        groups[date].total += feed.value
        if (feed.value > groups[date].max) {
          groups[date].max = feed.value
        }
        return groups;
      })
      delete data_by_date.id
      delete data_by_date.created_at
      delete data_by_date.record_at
      delete data_by_date.value
      delete data_by_date.notes
      weights = data.map(e => new Weight(DateTime.fromISO(e.record_at), e.value))
      const feedingDates = getDaysArray(new Date("2022-08-29"), (new Date()).toLocaleDateString("sv"));

      let feedingOptions = {
        chart: {
          locales: locales,
          defaultLocale: "zh-cn",
          type: 'line',
          toolbar: {
            show: true
          }
        },
        dataLabels: {
          enabled: true,
          enabledOnSeries: [1]
        },
        series: [
          {
            name: "æ€»é‡",
            type: 'bar',
            data: Object.values(data_by_date).map(d => d.total),
          },
          {
            name: "å•æ¬¡æœ€å¤š",
            type: 'line',
            data: Object.values(data_by_date).map(d => d.max),
          }
        ],
        stroke: {
          width: 3,
          curve: 'smooth'
        },
        xaxis: {
          type: "datetime",
          categories: Object.keys(data_by_date),
        },
        yaxis: [
          {
            axisTicks: {
              show: true
            },
            axisBorder: {
              show: true,
              color: "#FF1654"
            },
            labels: {
              style: {
                colors: "#FF1654"
              }
            },
            title: {
              text: "æ€»é‡ml",
              style: {
                color: "#FF1654"
              }
            }
          },
          {
            opposite: true,
            axisTicks: {
              show: true
            },
            axisBorder: {
              show: true,
              color: "#247BA0"
            },
            labels: {
              style: {
                colors: "#247BA0"
              }
            },
            title: {
              text: "å•æ¬¡æœ€å¤šml",
              style: {
                color: "#247BA0"
              }
            }
          }
        ],
      }
      let feedingChart = new ApexCharts(document.querySelector("#feeding"), feedingOptions);
      feedingChart.render();

      const feedingByHourOptions = {
        series: feedingDates.map(d => {
          let entries = weights.filter(e => e.record_at.toISODate() === d)
          let ser = Array(24).fill(0).map((a, b) => { return { x: (a + b).toString(), y: 0 } })
          entries.map(e => { ser[e.record_at.hour].y += e.value })
          return { name: d, data: ser }
        }),
        chart: {
          height: 600,
          type: 'heatmap',
        },
        dataLabels: {
          enabled: false
        },
        colors: ["#008FFB"],
        title: {
          text: 'æ¯å°æ—¶å¥¶é‡'
        },
      }
      let feedingByHourChart = new ApexCharts(document.querySelector("#feeding-by-hour"), feedingByHourOptions);
      feedingByHourChart.render();
    })

</script>
